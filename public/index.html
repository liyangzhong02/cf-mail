<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF Mail Post Office</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden" x-data="app()">

    <!-- Login Screen -->
    <div x-show="!isLoggedIn" x-cloak class="h-full flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-gray-200">
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4">
                    <i class="ph ph-envelope-simple text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">CF Mail Login</h1>
                <p class="text-gray-500 mt-2">Enter your admin password to access mailboxes.</p>
            </div>

            <form @submit.prevent="login">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" x-model="password"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        placeholder="Admin Password" required>
                </div>

                <div x-show="loginError" class="mb-4 text-red-500 text-sm text-center" x-text="loginError"></div>

                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg transition duration-200 flex items-center justify-center gap-2"
                    :disabled="isLoading">
                    <span x-show="!isLoading">Sign In</span>
                    <i x-show="isLoading" class="ph ph-spinner animate-spin text-xl"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div x-show="isLoggedIn" x-cloak class="h-full flex flex-col">

        <!-- Navbar -->
        <header
            class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 flex-shrink-0 z-10">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center">
                    <i class="ph ph-envelope-open text-lg"></i>
                </div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">CF Post Office</h1>
            </div>
            <div class="flex items-center gap-4">
                <button @click="logout"
                    class="text-gray-500 hover:text-red-600 transition flex items-center gap-2 text-sm font-medium">
                    <i class="ph ph-sign-out text-lg"></i> Logout
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 flex overflow-hidden">

            <!-- Sidebar: Mailboxes -->
            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Mailboxes</h2>
                    <button @click="showCreateModal = true"
                        class="text-blue-600 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition"
                        title="New Mailbox">
                        <i class="ph ph-plus-circle text-xl"></i>
                    </button>
                </div>

                <div class="overflow-y-auto flex-1 p-2 space-y-1">
                    <template x-for="box in mailboxes" :key="box.id">
                        <div @click="selectMailbox(box)"
                            class="group flex items-center justify-between p-2.5 rounded-lg cursor-pointer transition text-sm relative"
                            :class="selectedMailbox?.id === box.id ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'">

                            <div class="flex items-center gap-3 overflow-hidden">
                                <i class="ph text-lg"
                                    :class="selectedMailbox?.id === box.id ? 'ph-envelope-open text-blue-500' : 'ph-envelope text-gray-400'"></i>
                                <span class="truncate font-medium" x-text="box.address"></span>
                            </div>

                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button @click.stop="copyToClipboard(box.address)"
                                    class="text-gray-400 hover:text-blue-500 p-1 rounded" title="Copy Address">
                                    <i class="ph ph-copy"></i>
                                </button>
                                <button @click.stop="deleteMailbox(box.id)"
                                    class="text-gray-400 hover:text-red-500 p-1 rounded" title="Delete Mailbox">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>
                    </template>

                    <div x-show="mailboxes.length === 0 && !isLoading" class="text-center py-8 text-gray-400 text-sm">
                        No mailboxes yet.
                    </div>
                </div>
            </aside>

            <!-- Middle: Message List -->
            <div class="w-80 bg-white border-r border-gray-200 flex flex-col flex-shrink-0" x-show="selectedMailbox">
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50 h-[57px]">
                    <h3 class="font-semibold text-gray-800 truncate pr-2" x-text="selectedMailbox?.address"></h3>
                    <button @click="fetchMessages(selectedMailbox.id)"
                        class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-200 transition"
                        :class="{'animate-spin': isLoadingMessages}">
                        <i class="ph ph-arrow-clockwise text-lg"></i>
                    </button>
                </div>

                <div class="overflow-y-auto flex-1">
                    <template x-for="msg in messages" :key="msg.id">
                        <div @click="selectMessage(msg.id)"
                            class="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition"
                            :class="{'bg-blue-50/60': selectedMessage?.id === msg.id, 'bg-white': selectedMessage?.id !== msg.id}">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-semibold text-gray-900 text-sm truncate w-2/3"
                                    x-text="msg.sender || 'Unknown'"></span>
                                <span class="text-xs text-gray-500 whitespace-nowrap"
                                    x-text="formatDate(msg.received_at)"></span>
                            </div>
                            <div class="text-sm text-gray-800 font-medium truncate mb-1"
                                :class="{'text-gray-600 font-normal': msg.is_read}"
                                x-text="msg.subject || '(No Subject)'"></div>

                            <!-- Quick Copy Verification Code -->
                            <div x-show="msg.verification_code" class="flex items-center gap-2 mb-1">
                                <span
                                    class="bg-blue-100/50 text-blue-700 text-xs px-1.5 py-0.5 rounded font-mono font-bold border border-blue-100"
                                    x-text="msg.verification_code"></span>
                                <button @click.stop="copyToClipboard(msg.verification_code)"
                                    class="text-gray-400 hover:text-blue-600 p-0.5 rounded transition bg-white/50 hover:bg-white shadow-sm border border-transparent hover:border-gray-200"
                                    title="Copy Code">
                                    <i class="ph ph-copy"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 truncate" x-text="msg.preview || 'No preview available'">
                            </div>
                        </div>
                    </template>
                    <div x-show="messages.length === 0 && !isLoadingMessages"
                        class="text-center py-12 text-gray-400 text-sm px-6">
                        <div class="mb-2"><i class="ph ph-tray text-3xl"></i></div>
                        No messages in this mailbox.
                    </div>
                </div>
            </div>

            <!-- Empty State for Message List -->
            <div class="flex-1 flex items-center justify-center bg-gray-50 text-gray-400 flex-col"
                x-show="!selectedMailbox">
                <i class="ph ph-sidebar text-4xl mb-3"></i>
                <p>Select a mailbox to view messages</p>
            </div>

            <!-- Right: Message Detail -->
            <main class="flex-1 flex flex-col bg-white overflow-hidden relative" x-show="selectedMessage">
                <!-- Toolbar -->
                <div
                    class="h-[57px] border-b border-gray-200 flex items-center justify-between px-6 bg-white flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button @click="selectedMessage = null" class="lg:hidden text-gray-500 hover:text-gray-700">
                            <i class="ph ph-arrow-left text-xl"></i>
                        </button>
                        <div class="flex gap-2">
                            <!-- Actions could go here -->
                        </div>
                    </div>
                    <button @click="deleteMessage(selectedMessage.id)"
                        class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="ph ph-trash text-lg"></i> Delete
                    </button>
                </div>

                <!-- Reading Pane -->
                <div class="flex-1 overflow-y-auto" x-show="!isLoadingContent">
                    <div class="p-6 pb-2">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-900"
                                x-text="selectedMessage?.subject || '(No Subject)'"></h2>

                            <div x-show="selectedMessage?.verification_code"
                                class="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                                <span class="text-xs text-blue-600 font-semibold uppercase tracking-wider">Code:</span>
                                <span class="text-lg font-mono font-bold text-blue-700"
                                    x-text="selectedMessage?.verification_code"></span>
                                <button @click="copyToClipboard(selectedMessage?.verification_code)"
                                    class="ml-1 text-blue-400 hover:text-blue-600 transition" title="Copy Code">
                                    <i class="ph ph-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-start justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                                    <span x-text="(selectedMessage?.sender || '?')[0].toUpperCase()"></span>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">
                                        <span x-text="selectedMessage?.sender"></span>
                                    </div>
                                    <div class="text-xs text-gray-500"
                                        x-text="'To: ' + (selectedMessage?.mailbox_address || 'Me')"></div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500" x-text="formatFullDate(selectedMessage?.received_at)">
                            </div>
                        </div>

                        <!-- Attachments -->
                        <div x-show="selectedMessage?.attachments?.length > 0" class="flex flex-wrap gap-2 mb-6">
                            <template x-for="att in selectedMessage?.attachments" :key="att.id">
                                <div
                                    class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 border border-gray-200 rounded-lg text-sm text-gray-700">
                                    <i class="ph ph-paperclip"></i>
                                    <span x-text="att.filename" class="truncate max-w-[150px]"></span>
                                    <span class="text-xs text-gray-400" x-text="formatSize(att.size)"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="border-t border-gray-200">
                        <!-- Email Content Frame -->
                        <div class="w-full h-full min-h-[500px] bg-white">
                            <template x-if="selectedMessage">
                                <iframe class="w-full h-full min-h-[600px] border-none"
                                    :srcdoc="selectedMessage.html || '<pre class=\'p-4 font-sans whitespace-pre-wrap\'>' + (selectedMessage.text || 'No content') + '</pre>'"
                                    onload="this.style.height = this.contentWindow.document.documentElement.scrollHeight + 'px'"></iframe>
                            </template>
                        </div>
                    </div>

                    <!-- Raw EML Link -->
                    <div class="p-6 pt-2 text-right">
                        <a :href="'/api/messages/' + selectedMessage?.id + '/raw'" target="_blank"
                            class="text-xs text-blue-500 hover:underline">View Raw EML</a>
                    </div>
                </div>

                <div x-show="isLoadingContent" class="absolute inset-0 flex items-center justify-center bg-white z-20">
                    <i class="ph ph-spinner animate-spin text-3xl text-blue-500"></i>
                </div>
            </main>

            <!-- Empty State for Details -->
            <div class="flex-1 flex items-center justify-center bg-gray-50 text-gray-400 flex-col"
                x-show="selectedMailbox && !selectedMessage">
                <i class="ph ph-envelope-open text-4xl mb-3 opacity-50"></i>
                <p>Select a message to read</p>
            </div>
        </div>
    </div>

    <!-- Create Mailbox Modal -->
    <div x-show="showCreateModal" x-cloak
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div @click.outside="showCreateModal = false"
            class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Create New Mailbox</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Address (Optional)</label>
                    <div class="flex">
                        <input type="text" x-model="newMailboxAddress" placeholder="e.g. support"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                        <div
                            class="bg-gray-100 border border-l-0 border-gray-300 px-3 py-2 text-sm text-gray-500 rounded-r-lg flex items-center">
                            @...
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Leave empty to generate a random address.</p>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showCreateModal = false"
                        class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">Cancel</button>
                    <button @click="createMailbox"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition relative">
                        <span x-show="!isCreating">Create</span>
                        <span x-show="isCreating"><i class="ph ph-spinner animate-spin"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false,
                password: '',
                loginError: '',
                isLoading: false,
                mailboxes: [],
                messages: [],
                selectedMailbox: null,
                selectedMessage: null,
                isLoadingMessages: false,
                isLoadingContent: false,
                showCreateModal: false,
                newMailboxAddress: '',
                isCreating: false,

                async init() {
                    // Check auth status by trying to fetch mailboxes (or check cookie existence if we could, but HTTPOnly)
                    // We'll just try to fetch mailboxes, if 401 then not logged in.
                    await this.checkAuth();
                },

                async checkAuth() {
                    try {
                        const res = await fetch('/api/mailboxes');
                        if (res.ok) {
                            this.isLoggedIn = true;
                            const data = await res.json();
                            this.mailboxes = data.mailboxes;
                        } else if (res.status === 401) {
                            this.isLoggedIn = false;
                        }
                    } catch (e) {
                        console.error("Auth check failed", e);
                        this.isLoggedIn = false;
                    }
                },

                async login() {
                    this.isLoading = true;
                    this.loginError = '';
                    try {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.password })
                        });
                        const data = await res.json();

                        if (res.ok) {
                            this.isLoggedIn = true;
                            this.password = '';
                            this.fetchMailboxes();
                        } else {
                            this.loginError = data.error || 'Login failed';
                        }
                    } catch (e) {
                        this.loginError = 'Network error';
                    } finally {
                        this.isLoading = false;
                    }
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    this.isLoggedIn = false;
                    this.mailboxes = [];
                    this.selectedMailbox = null;
                    this.messages = [];
                    this.selectedMessage = null;
                },

                async fetchMailboxes() {
                    const res = await fetch('/api/mailboxes');
                    if (res.ok) {
                        const data = await res.json();
                        this.mailboxes = data.mailboxes;
                    }
                },

                async createMailbox() {
                    this.isCreating = true;
                    try {
                        const payload = this.newMailboxAddress ? { address: this.newMailboxAddress } : {};
                        const res = await fetch('/api/mailboxes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            await this.fetchMailboxes();
                            this.showCreateModal = false;
                            this.newMailboxAddress = '';
                        } else {
                            const data = await res.json();
                            alert(data.error || 'Failed to create mailbox');
                        }
                    } catch (e) {
                        alert('Error creating mailbox');
                    } finally {
                        this.isCreating = false;
                    }
                },

                async deleteMailbox(id) {
                    if (!confirm('Are you sure? All messages in this mailbox will be deleted.')) return;

                    const res = await fetch(`/api/mailboxes/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        if (this.selectedMailbox?.id === id) {
                            this.selectedMailbox = null;
                            this.messages = [];
                            this.selectedMessage = null;
                        }
                        await this.fetchMailboxes();
                    }
                },

                async selectMailbox(box) {
                    this.selectedMailbox = box;
                    this.selectedMessage = null;
                    await this.fetchMessages(box.id);
                },

                async fetchMessages(mailboxId) {
                    this.isLoadingMessages = true;
                    this.messages = []; // Clear while loading
                    try {
                        const res = await fetch(`/api/mailboxes/${mailboxId}/messages`);
                        if (res.ok) {
                            const data = await res.json();
                            this.messages = data.messages;
                        }
                    } finally {
                        this.isLoadingMessages = false;
                    }
                },

                async selectMessage(id) {
                    // Update UI immediately for selection state
                    // Fetch full details
                    this.isLoadingContent = true;
                    this.selectedMessage = { id }; // Placeholder
                    try {
                        const res = await fetch(`/api/messages/${id}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.selectedMessage = data.message;

                            // Mark local message as read
                            const msgIndex = this.messages.findIndex(m => m.id === id);
                            if (msgIndex !== -1) {
                                this.messages[msgIndex].is_read = 1;
                            }
                        }
                    } finally {
                        this.isLoadingContent = false;
                    }
                },

                async deleteMessage(id) {
                    if (!confirm('Delete this message?')) return;

                    const res = await fetch(`/api/messages/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        this.selectedMessage = null;
                        await this.fetchMessages(this.selectedMailbox.id);
                    }
                },

                formatDate(isoString) {
                    if (!isoString) return '';
                    const date = new Date(isoString);
                    // If today, show time, else show date
                    const now = new Date();
                    if (date.toDateString() === now.toDateString()) {
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    return date.toLocaleDateString();
                },

                formatFullDate(isoString) {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleString();
                },

                formatSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                async copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        // Optional: show a toast or change icon briefly
                        // We'll use a simple alert-like UI or just rely on console for now if no toast system,
                        // but actually let's just log it or maybe a temporary visual indicator would be better.
                        // For simplicity in this step, we can assume it works if no error.
                        // Let's create a temporary tooltip or just a simple alert for now?
                        // Actually, I'll add a 'showToast' variable and method to make it nice.
                        this.showToast('Copied to clipboard');
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                    }
                },

                showToast(message) {
                    // Create toast element dynamically
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm animate-bounce';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                }
            }
        }
    </script>
</body>

</html>